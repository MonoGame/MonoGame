
# Repo: codefoco/AzureDevopsTemplates
resources:
  repositories:
    - repository: templates
      type: github
      name: codefoco/AzureDevopsTemplates
      endpoint: codefoco

pool:
  vmImage: 'windows-2019'
  demands:
  - msbuild
  - visualstudio
  - vstest

steps:
- checkout: self
  submodules: true

- template: common-dotnet.yml@templates
- template: common-win.yml@templates

- task: PowerShell@2
  displayName: 'PreBuild Script MonoGame'
  inputs:
    targetType: filePath
    filePath: ./devops/PreBuild.ps1
    arguments: 'Codefoco.MonoGame.Framework Codefoco.MonoGame.Framework.nuspec'
    errorActionPreference: 'silentlyContinue'
    pwsh: true

- task: PowerShell@2
  displayName: 'Cake Build MonoGame.Framework'
  inputs:
    targetType: filePath
    filePath: ./build.ps1

- task: DownloadBuildArtifacts@0
  displayName: 'Download Build Xamarin.iOS.MonoGame.Framework.dll'
  inputs:
    buildType: 'specific'
    project: 'NuGets'
    definition: 'Codefoco.MonoGame.Framework.Mac'
    specificBuildWithTriggering: true
    artifactName: Xamarin.iOS.MonoGame.Framework.dll

- task: DownloadBuildArtifacts@0
  displayName: 'Download Build Xamarin.iOS.MonoGame.Framework.pdb'
  inputs:
    buildType: 'specific'
    project: 'NuGets'
    definition: 'Codefoco.MonoGame.Framework.Mac'
    specificBuildWithTriggering: true
    artifactName: Xamarin.iOS.MonoGame.Framework.pdb

- task: DownloadBuildArtifacts@0
  displayName: 'Download Build Xamarin.iOS.MonoGame.Framework.xml'
  inputs:
    buildType: 'specific'
    project: 'NuGets'
    definition: 'Codefoco.MonoGame.Framework.Mac'
    specificBuildWithTriggering: true
    artifactName: Xamarin.iOS.MonoGame.Framework.xml

- task: DownloadBuildArtifacts@0
  displayName: 'Download Build Xamarin.tvOS.MonoGame.Framework.dll'
  inputs:
    buildType: 'specific'
    project: 'NuGets'
    definition: 'Codefoco.MonoGame.Framework.Mac'
    specificBuildWithTriggering: true
    artifactName: Xamarin.tvOS.MonoGame.Framework.dll

- task: DownloadBuildArtifacts@0
  displayName: 'Download Build Xamarin.tvOS.MonoGame.Framework.pdb'
  inputs:
    buildType: 'specific'
    project: 'NuGets'
    definition: 'Codefoco.MonoGame.Framework.Mac'
    specificBuildWithTriggering: true
    artifactName: Xamarin.tvOS.MonoGame.Framework.pdb

- task: DownloadBuildArtifacts@0
  displayName: 'Download Build Xamarin.tvOS.MonoGame.Framework.xml'
  inputs:
    buildType: 'specific'
    project: 'NuGets'
    definition: 'Codefoco.MonoGame.Framework.Mac'
    specificBuildWithTriggering: true
    artifactName: Xamarin.tvOS.MonoGame.Framework.xml

- task: CopyFiles@2
  displayName: 'Copy Files to: MonoGame.Framework/bin/iOSCore/Release/xamarinios10/MonoGame.Framework.dll'
  inputs:
    SourceFolder: '$(System.ArtifactsDirectory)\Xamarin.iOS.MonoGame.Framework.dll\'
    TargetFolder: MonoGame.Framework/bin/iOSCore/Release/xamarinios10/

- task: CopyFiles@2
  displayName: 'Copy Files to: MonoGame.Framework/bin/iOSCore/Release/xamarinios10/MonoGame.Framework.pdb'
  inputs:
    SourceFolder: '$(System.ArtifactsDirectory)\Xamarin.iOS.MonoGame.Framework.pdb\'
    TargetFolder: MonoGame.Framework/bin/iOSCore/Release/xamarinios10/

- task: CopyFiles@2
  displayName: 'Copy Files to: MonoGame.Framework/bin/iOSCore/Release/xamarinios10/MonoGame.Framework.xml'
  inputs:
    SourceFolder: '$(System.ArtifactsDirectory)\Xamarin.iOS.MonoGame.Framework.xml\'
    TargetFolder: MonoGame.Framework/bin/iOSCore/Release/xamarinios10/

- task: CopyFiles@2
  displayName: 'Copy Files to: MonoGame.Framework/bin/iOSCore/Release/xamarintvos10/MonoGame.Framework.dll'
  inputs:
    SourceFolder: '$(System.ArtifactsDirectory)\Xamarin.tvOS.MonoGame.Framework.dll\'
    TargetFolder: MonoGame.Framework/bin/iOSCore/Release/xamarintvos10/

- task: CopyFiles@2
  displayName: 'Copy Files to: MonoGame.Framework/bin/iOSCore/Release/xamarintvos10/MonoGame.Framework.pdb'
  inputs:
    SourceFolder: '$(System.ArtifactsDirectory)\Xamarin.tvOS.MonoGame.Framework.pdb\'
    TargetFolder: MonoGame.Framework/bin/iOSCore/Release/xamarintvos10/

- task: CopyFiles@2
  displayName: 'Copy Files to: MonoGame.Framework/bin/iOSCore/Release/xamarintvos10/MonoGame.Framework.xml'
  inputs:
    SourceFolder: '$(System.ArtifactsDirectory)\Xamarin.tvOS.MonoGame.Framework.xml\'
    TargetFolder: MonoGame.Framework/bin/iOSCore/Release/xamarintvos10/

- script: 'nuget setapikey $(apikey)'
  displayName: 'Set NuGet API Key'

- task: PowerShell@2
  displayName: 'Package Codefoco.MonoGame.Framework.nuget NuGet'
  inputs:
    targetType: filePath
    filePath: ./devops/Package.ps1
    arguments: 'Codefoco.MonoGame.Framework Codefoco.MonoGame.Framework.nuspec'

- script: 'rename Codefoco.MonoGame.Framework.*.nupkg Codefoco.MonoGame.Framework.nupkg'
  displayName: 'Rename Fantas.MonoGame Nuget Package'

- task: PublishBuildArtifacts@1
  displayName: 'Save Codefoco.MonoGame.Framework.nupkg Artifact'
  inputs:
    PathtoPublish: Codefoco.MonoGame.Framework.nupkg
    ArtifactName: Codefoco.MonoGame.Framework.nupkg

- task: PowerShell@2
  displayName: 'Publish Codefoco.MonoGame.Framework NuGet'
  inputs:
    targetType: filePath
    filePath: ./devops/Publish.ps1
    arguments: Codefoco.MonoGame.Framework

- template: send-telegram.yml@templates
