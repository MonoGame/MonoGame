<Project>

  <UsingTask TaskName="MonoGame.Build.Tasks.CollectContentReferences" AssemblyFile="MonoGame.Build.Tasks.dll" />

  <!-- Add MonoGameContentReference to item type selection in Visual Studio -->
  <ItemGroup>
    <AvailableItemName Include="MonoGameContentReference" />
  </ItemGroup>

  <!-- This disables the IDE feature that skips executing msbuild in some build situations. -->
  <PropertyGroup>
    <DisableFastUpToDateCheck>true</DisableFastUpToDateCheck>
  </PropertyGroup>

  <PropertyGroup>
    <BuildDependsOn>
      BuildContent;
      $(BuildDependsOn);
    </BuildDependsOn>
  </PropertyGroup>

  <Target Name="UpdateMGCB">

  </Target>

  <Target Name="PrepareMGCB">

    <PropertyGroup>
      <PlatformResourcePrefix Condition="'$(MonoGamePlatform)' == 'MacOSX'">$(MonoMacResourcePrefix)</PlatformResourcePrefix>
      <PlatformResourcePrefix Condition="'$(MonoGamePlatform)' == 'iOS'">$(IPhoneResourcePrefix)</PlatformResourcePrefix>
      <PlatformResourcePrefix Condition="'$(MonoGamePlatform)' == 'Android'">$(MonoAndroidAssetsPrefix)</PlatformResourcePrefix>
      <PlatformResourcePrefix Condition="'$(PlatformResourcePrefix)' != '' And !HasTrailingSlash('$(PlatformResourcePrefix)')">$(PlatformResourcePrefix)\</PlatformResourcePrefix>
      <PlatformResourcePrefix Condition="'$(PlatformResourcePrefix)' == ''"></PlatformResourcePrefix>
    </PropertyGroup>

    <!-- Get all Mono Game Content References and store them in a list -->
    <!-- We do this here so we are compatible with xbuild -->
    <CollectContentReferences ContentReferences="@(MonoGameContentReference)" MonoGamePlatform="$(MonoGamePlatform)">
      <Output TaskParameter="Output" ItemName="ContentReferences"/>
    </CollectContentReferences>

    <Error
      Text="The MonoGamePlatform property was not defined in the project!  It must be set to Windows, WindowsGL, WindowsStoreApp, WindowsPhone8, MacOSX, iOS, Linux, DesktopGL, RaspberryPi, Android, Ouya, NativeClient, PlayStation4, PSVita, XboxOne or PlayStationMobile."
      Condition="'$(MonoGamePlatform)' != 'Windows' And
                 '$(MonoGamePlatform)' != 'iOS' And       
                 '$(MonoGamePlatform)' != 'Android' And       
                 '$(MonoGamePlatform)' != 'Linux' And           
                 '$(MonoGamePlatform)' != 'DesktopGL' And           
                 '$(MonoGamePlatform)' != 'MacOSX' And       
                 '$(MonoGamePlatform)' != 'WindowsStoreApp' And       
                 '$(MonoGamePlatform)' != 'NativeClient' And       
                 '$(MonoGamePlatform)' != 'PlayStationMobile' And       
                 '$(MonoGamePlatform)' != 'WindowsPhone8' And       
                 '$(MonoGamePlatform)' != 'RaspberryPi' And       
                 '$(MonoGamePlatform)' != 'PlayStation4' And       
                 '$(MonoGamePlatform)' != 'PSVita' And       
                 '$(MonoGamePlatform)' != 'XboxOne' And 
                 '$(MonoGamePlatform)' != 'WindowsGL'" />

    <Warning
      Text="No Content References Found. Please make sure your .mgcb file has a build action of MonoGameContentReference"
      Condition=" '%(ContentReferences.FullPath)' == '' "
    />

    <MakeDir Directories="%(ContentReferences.ContentOutputDir)"/>
    <MakeDir Directories="%(ContentReferences.ContentIntermediateOutputDir)"/>

  </Target>

  <Target Name="RunMGCB" DependsOnTargets="UpdateMGCB;PrepareMGCB">

    <Exec
      Condition=" '%(ContentReferences.FullPath)' != '' "
      Command="$(MGCBCommand) $(MGCBArguments) /@:&quot;%(ContentReferences.FullPath)&quot; /outputDir:&quot;%(ContentReferences.ContentOutputDir)&quot; /intermediateDir:&quot;%(ContentReferences.ContentIntermediateOutputDir)&quot;"
      WorkingDirectory="%(ContentReferences.RootDir)%(ContentReferences.Directory)" />

    <CreateItem
      Include="%(ContentReferences.RelativeFullPath)%(ContentReferences.ContentOutputDir)\**\*.*"
      AdditionalMetadata="ContentOutputDir=%(ContentReferences.ContentDirectory)">
      <Output TaskParameter="Include" ItemName="ExtraContent" />
    </CreateItem>

  </Target>

  <Target
    Name="BuildContent"
    DependsOnTargets="RunMGCB"
    Condition=" '@(MonoGameContentReference)' != '' "
    Outputs="%(ExtraContent.RecursiveDir)%(ExtraContent.Filename)%(ExtraContent.Extension)">

    <CreateItem
      Include="%(ExtraContent.FullPath)"
      AdditionalMetadata="Link=$(PlatformResourcePrefix)%(ExtraContent.ContentOutputDir)%(ExtraContent.RecursiveDir)%(ExtraContent.Filename)%(ExtraContent.Extension);CopyToOutputDirectory=PreserveNewest"
      Condition="'%(ExtraContent.Filename)' != ''">
      <Output TaskParameter="Include" ItemName="Content" Condition="'$(MonoGamePlatform)' != 'Android' And '$(MonoGamePlatform)' != 'iOS' And '$(MonoGamePlatform)' != 'MacOSX'" />
      <Output TaskParameter="Include" ItemName="BundleResource" Condition="'$(MonoGamePlatform)' == 'MacOSX' Or '$(MonoGamePlatform)' == 'iOS'" />
      <Output TaskParameter="Include" ItemName="AndroidAsset" Condition="'$(MonoGamePlatform)' == 'Android'" />
    </CreateItem>

  </Target>

</Project>
