<Project>

  <!-- Copy all output files of ProjectReferences that have the 'AppReference' metadata.
       This ensures we copy
         1. The app's dlls and dependencies (that would normally be copied if 'ReferenceOutputAssembly' were true)
         2. The extra *.deps.json and *.runtimeconfig.json files that require a custom target to copy anyway.
            See https://github.com/dotnet/sdk/issues/1675#issuecomment-346135772 -->
  <Target Name="CopyAppReferences" BeforeTargets="GetCopyToOutputDirectoryItems">

    <!-- Get the output folders of all AppReferences. -->
    <MSBuild Projects="%(ProjectReference.FullPath)"
             Targets="GetTargetPath"
             Properties="Configuration=$(Configuration)"
             Condition="'%(ProjectReference.AppReference)' != ''">
      <Output TaskParameter="TargetOutputs"
              ItemName="AppReferenceTargetPath" />
    </MSBuild>
    <ItemGroup>
      <AppReferenceTargetDirectory Include="$([System.IO.Path]::GetDirectoryName(%(AppReferenceTargetPath.FullPath)))" />
    </ItemGroup>

    <!-- Include the entire output folder except for publish artifacts, pack artifacts, and dev configs. -->
    <ItemGroup>
      <AppReferenceContent Include="%(AppReferenceTargetDirectory.FullPath)\**\*"
                           Exclude="%(AppReferenceTargetDirectory.FullPath)\publish\**\*;
                                    %(AppReferenceTargetDirectory.FullPath)\*.nupkg;
                                    %(AppReferenceTargetDirectory.FullPath)\*.runtimeconfig.dev.json" />
    </ItemGroup>

    <!-- Copy this content to the build output. -->
    <ItemGroup>
      <ContentWithTargetPath
        Include="%(AppReferenceContent.FullPath)"
        TargetPath="%(RecursiveDir)%(Filename)%(Extension)"
        CopyToOutputDirectory="PreserveNewest" />
    </ItemGroup>

  </Target>

</Project>
